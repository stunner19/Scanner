<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>NSEScan — India Market Scanner</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Outfit:wght@300;400;600;800&display=swap"
    rel="stylesheet" />
  <style>
    /* ══ TOKENS ══════════════════════════════════════════════════════════════ */
    :root {
      --bg: #05070a;
      --surface: #0b0f14;
      --surface2: #111720;
      --surface3: #1a2233;
      --border: #1e2d40;
      --border-hi: #2e4560;
      --accent: #f0b429;
      /* saffron */
      --accent-dim: rgba(240, 180, 41, .12);
      --teal: #00d4aa;
      --teal-dim: rgba(0, 212, 170, .1);
      --blue: #3b9eff;
      --blue-dim: rgba(59, 158, 255, .1);
      --red: #ff4d6d;
      --green: #22d67a;
      --text: #e8eef5;
      --text-2: #8899aa;
      --text-3: #3d5068;
      --font-mono: 'JetBrains Mono', monospace;
      --font-display: 'Outfit', sans-serif;
      --radius: 8px;
      --glow-accent: 0 0 20px rgba(240, 180, 41, .25);
      --glow-teal: 0 0 16px rgba(0, 212, 170, .2);
    }

    /* ══ RESET ═══════════════════════════════════════════════════════════════ */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-mono);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── Scanline noise overlay ── */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        repeating-linear-gradient(0deg,
          transparent,
          transparent 2px,
          rgba(0, 0, 0, .03) 2px,
          rgba(0, 0, 0, .03) 4px);
      pointer-events: none;
      z-index: 1000;
    }

    /* ── Ambient glow blobs ── */
    body::after {
      content: '';
      position: fixed;
      top: -200px;
      left: -150px;
      width: 600px;
      height: 600px;
      background: radial-gradient(circle, rgba(240, 180, 41, .06) 0%, transparent 70%);
      pointer-events: none;
    }

    /* ══ LAYOUT ══════════════════════════════════════════════════════════════ */
    .page {
      max-width: 1140px;
      margin: 0 auto;
      padding: 0 24px 80px;
    }

    /* ══ HEADER ══════════════════════════════════════════════════════════════ */
    header {
      padding: 44px 0 36px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
      position: relative;
    }

    .header-inner {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 24px;
      flex-wrap: wrap;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .brand-logo {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-mark {
      width: 38px;
      height: 38px;
      background: var(--accent);
      clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      animation: logo-pulse 3s ease-in-out infinite;
    }

    @keyframes logo-pulse {

      0%,
      100% {
        box-shadow: var(--glow-accent);
      }

      50% {
        box-shadow: 0 0 32px rgba(240, 180, 41, .5);
      }
    }

    .logo-mark svg {
      width: 18px;
      height: 18px;
    }

    .brand-name {
      font-family: var(--font-display);
      font-size: 28px;
      font-weight: 800;
      letter-spacing: -1px;
      line-height: 1;
    }

    .brand-name em {
      color: var(--accent);
      font-style: normal;
    }

    .brand-tagline {
      font-size: 10px;
      letter-spacing: 2.5px;
      text-transform: uppercase;
      color: var(--text-3);
      font-family: var(--font-mono);
      margin-left: 52px;
    }

    .header-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
    }

    .live-badge {
      display: flex;
      align-items: center;
      gap: 7px;
      background: var(--surface2);
      border: 1px solid var(--border);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 11px;
      color: var(--text-2);
    }

    .live-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
      animation: blink 2s ease-in-out infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.3;
      }
    }

    .header-date {
      font-size: 11px;
      color: var(--text-3);
      font-family: var(--font-mono);
    }

    /* ══ CONTROLS PANEL ══════════════════════════════════════════════════════ */
    .panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 28px;
      margin-bottom: 28px;
    }

    .panel-label {
      font-size: 10px;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-3);
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .panel-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .controls-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field-label {
      font-size: 10px;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text-2);
    }

    select {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 13px;
      padding: 13px 40px 13px 16px;
      border-radius: 6px;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath fill='%233d5068' d='M5 6L0 0h10z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      transition: border-color .2s, box-shadow .2s, background .2s;
      width: 100%;
    }

    select:hover {
      border-color: var(--border-hi);
      background-color: var(--surface3);
    }

    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    select option {
      background: var(--surface2);
    }

    /* Strategy info box */
    .strategy-info {
      background: linear-gradient(135deg, var(--teal-dim), transparent);
      border: 1px solid rgba(0, 212, 170, .2);
      border-radius: 6px;
      padding: 13px 16px;
      font-size: 12px;
      color: var(--text-2);
      line-height: 1.6;
      display: none;
      margin-top: -4px;
    }

    .strategy-info.show {
      display: block;
      animation: fadeIn .2s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .strategy-info::before {
      content: '// ';
      color: var(--teal);
      font-weight: 700;
    }

    /* Scan button */
    .scan-btn {
      width: 100%;
      background: var(--accent);
      color: #000;
      border: none;
      font-family: var(--font-display);
      font-size: 14px;
      font-weight: 700;
      padding: 15px 32px;
      border-radius: 6px;
      cursor: pointer;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      transition: all .2s;
      position: relative;
      overflow: hidden;
    }

    .scan-btn::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 255, 255, .15), transparent);
    }

    .scan-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: var(--glow-accent), 0 8px 24px rgba(240, 180, 41, .3);
    }

    .scan-btn:active:not(:disabled) {
      transform: translateY(0);
    }

    .scan-btn:disabled {
      opacity: .4;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* ══ STATUS BAR ══════════════════════════════════════════════════════════ */
    .status-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2px;
      margin-bottom: 16px;
      min-height: 32px;
      gap: 12px;
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 12px;
      color: var(--text-2);
    }

    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin .6s linear infinite;
      display: none;
      flex-shrink: 0;
    }

    .spinner.on {
      display: block;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .scan-time {
      font-size: 11px;
      color: var(--text-3);
    }

    /* ══ RESULTS AREA ════════════════════════════════════════════════════════ */
    .results-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    /* Empty state */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 80px 24px;
      gap: 12px;
      text-align: center;
    }

    .empty-icon {
      width: 56px;
      height: 56px;
      border: 1px solid var(--border);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      color: var(--text-3);
      margin-bottom: 4px;
    }

    .empty-title {
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 600;
      color: var(--text-2);
    }

    .empty-hint {
      font-size: 12px;
      color: var(--text-3);
    }

    /* Summary bar */
    .summary-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: var(--surface2);
      border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
      gap: 10px;
    }

    .summary-left {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 12px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .chip-green {
      background: rgba(34, 214, 122, .12);
      color: var(--green);
      border: 1px solid rgba(34, 214, 122, .25);
    }

    .chip-amber {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid rgba(240, 180, 41, .25);
    }

    .chip-blue {
      background: var(--blue-dim);
      color: var(--blue);
      border: 1px solid rgba(59, 158, 255, .2);
    }

    .chip-dim {
      background: var(--surface3);
      color: var(--text-2);
      border: 1px solid var(--border);
    }

    .summary-right {
      font-size: 11px;
      color: var(--text-3);
    }

    /* ── Table ── */
    .table-wrap {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 10;
    }

    thead tr {
      background: var(--surface2);
      border-bottom: 2px solid var(--border);
    }

    th {
      padding: 11px 16px;
      text-align: left;
      font-size: 9.5px;
      letter-spacing: 1.8px;
      text-transform: uppercase;
      color: var(--text-3);
      font-weight: 500;
      white-space: nowrap;
      font-family: var(--font-mono);
    }

    th:first-child {
      padding-left: 20px;
    }

    th:last-child {
      padding-right: 20px;
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background .15s;
      animation: rowSlide .35s ease both;
    }

    @keyframes rowSlide {
      from {
        opacity: 0;
        transform: translateX(-10px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    tbody tr:hover {
      background: var(--surface2);
      cursor: default;
    }

    td {
      padding: 15px 16px;
      vertical-align: middle;
      white-space: nowrap;
    }

    td:first-child {
      padding-left: 20px;
    }

    td:last-child {
      padding-right: 20px;
    }

    /* Ticker column */
    .t-ticker {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .t-name {
      font-family: var(--font-display);
      font-weight: 700;
      font-size: 15px;
      color: var(--text);
      letter-spacing: 0.3px;
    }

    .t-exch {
      font-size: 9px;
      letter-spacing: 1.5px;
      color: var(--text-3);
      text-transform: uppercase;
    }

    /* Price column */
    .t-price {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    .t-price-sub {
      font-size: 10px;
      color: var(--text-3);
      margin-top: 2px;
    }

    /* Change column */
    .up {
      color: var(--green);
    }

    .down {
      color: var(--red);
    }

    .t-change {
      font-weight: 600;
      font-size: 13px;
    }

    /* Signal column */
    .t-signal {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sig-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .sig-dot.strong {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }

    .sig-dot.moderate {
      background: var(--teal);
      box-shadow: 0 0 6px var(--teal);
    }

    .sig-text {
      font-size: 12px;
      color: var(--text-2);
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Strength column */
    .strength-pill {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }

    .strong {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .moderate {
      background: var(--teal-dim);
      color: var(--teal);
    }

    /* Metric column */
    .t-metric {
      font-size: 12px;
      color: var(--text-2);
      text-align: right;
    }

    .t-metric-label {
      font-size: 9.5px;
      color: var(--text-3);
      margin-bottom: 2px;
    }

    /* ══ ERROR BOX ════════════════════════════════════════════════════════════ */
    .error-box {
      background: rgba(255, 77, 109, .07);
      border: 1px solid rgba(255, 77, 109, .3);
      border-radius: 6px;
      padding: 14px 18px;
      font-size: 12px;
      color: var(--red);
      margin-bottom: 16px;
      display: none;
    }

    .error-box.show {
      display: block;
    }

    /* ══ FOOTER ══════════════════════════════════════════════════════════════ */
    footer {
      margin-top: 60px;
      padding: 20px 0;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 11px;
      color: var(--text-3);
    }

    footer a {
      color: var(--text-2);
      text-decoration: none;
    }

    footer a:hover {
      color: var(--accent);
    }

    /* ══ RESPONSIVE ══════════════════════════════════════════════════════════ */
    @media (max-width: 680px) {
      .controls-row {
        grid-template-columns: 1fr;
      }

      .header-meta {
        display: none;
      }

      th.r-hide,
      td.r-hide {
        display: none;
      }

      .brand-name {
        font-size: 22px;
      }
    }

    /* ══ AUTH PANEL ══════════════════════════════════════════════════════════ */
    .auth-panel {
      background: var(--surface);
      border: 1px solid rgba(240, 180, 41, .25);
      border-left: 3px solid var(--accent);
      border-radius: var(--radius);
      padding: 20px 24px;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .auth-status {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }

    .auth-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .auth-dot.ok {
      background: var(--green);
      box-shadow: 0 0 8px var(--green);
    }

    .auth-dot.warning {
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
      animation: blink 1.5s ease-in-out infinite;
    }

    .auth-right {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .auth-input {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 12px;
      padding: 9px 14px;
      border-radius: 6px;
      width: 280px;
      transition: border-color .2s;
    }

    .auth-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .auth-input::placeholder {
      color: var(--text-3);
    }

    .auth-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 600;
      padding: 9px 16px;
      border-radius: 6px;
      cursor: pointer;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      transition: all .2s;
      white-space: nowrap;
    }

    .auth-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .auth-btn.primary {
      background: var(--accent);
      color: #000;
      border-color: var(--accent);
    }

    .auth-btn.primary:hover {
      box-shadow: var(--glow-accent);
    }

    .auth-link {
      font-size: 11px;
      color: var(--teal);
      text-decoration: none;
    }

    .auth-link:hover {
      text-decoration: underline;
    }


    /* ── Progress Bar ─────────────────────────────────────────────── */
    .progress-wrap {
      margin: 8px 0 12px;
      display: none;
    }

    .progress-wrap.show {
      display: block;
    }

    .progress-bar-track {
      height: 4px;
      background: var(--surface2);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--teal));
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s ease;
    }

    .progress-label {
      font-size: 11px;
      color: var(--text-3);
      margin-top: 6px;
      font-family: var(--font-mono);
    }
  </style>
</head>

<body>
  <div class="page">

    <!-- ── HEADER ── -->
    <header>
      <div class="header-inner">
        <div class="brand">
          <div class="brand-logo">
            <div class="logo-mark">
              <svg viewBox="0 0 18 18" fill="none">
                <path d="M2 14 L6 8 L10 11 L14 4 L16 6" stroke="#000" stroke-width="2" stroke-linecap="round"
                  stroke-linejoin="round" />
                <circle cx="14" cy="4" r="1.5" fill="#000" />
              </svg>
            </div>
            <span class="brand-name">NSE<em>Scan</em></span>
          </div>
          <span class="brand-tagline">Indian Stock Market · Technical Scanner</span>
        </div>

        <div class="header-meta">
          <div class="live-badge">
            <span class="live-dot"></span>
            Yahoo Finance Data
          </div>
          <div class="header-date" id="headerDate"></div>
        </div>
      </div>
    </header>

    <!-- ── UPSTOX AUTH PANEL ── -->
    <div class="auth-panel" id="authPanel">
      <div class="auth-status">
        <div class="auth-dot warning" id="authDot"></div>
        <span id="authMsg" style="color:var(--text-2)">Checking Upstox token...</span>
      </div>
      <div class="auth-right" id="authControls">
        <span style="font-size:11px;color:var(--text-3)">One-time setup required</span>
        <a class="auth-btn primary" id="loginLink" href="#" target="_blank">
          Login with Upstox ↗
        </a>
      </div>
    </div>

    <!-- ── SCANNER PANEL ── -->
    <div class="panel">
      <div class="panel-label">Scanner Configuration</div>

      <div class="controls-row">
        <!-- Strategy selector -->
        <div class="field">
          <label class="field-label" for="strategySelect">Strategy</label>
          <select id="strategySelect">
            <option value="">── Select strategy ──</option>
          </select>
          <div class="strategy-info" id="strategyInfo"></div>
        </div>

        <!-- Universe selector -->
        <div class="field">
          <label class="field-label" for="universeSelect">Stock Universe</label>
          <select id="universeSelect">
            <option value="">── Select universe ──</option>
          </select>
        </div>
      </div>

      <!-- Scan button -->
      <button class="scan-btn" id="scanBtn" disabled onclick="runScan()">
        ▶ &nbsp;Run Scanner
      </button>
    </div>

    <div class="error-box" id="errorBox"></div>

    <!-- Status -->
    <div class="status-bar">
      <div class="status-left">
        <div class="spinner" id="spinner"></div>
        <span id="statusMsg" style="color:var(--text-3);font-size:12px">
          Select a strategy and universe to begin.
        </span>
      </div>
      <span class="scan-time" id="scanTime"></span>
    </div>

    <!-- Progress bar — sits between status bar and results -->
    <div class="progress-wrap" id="progressWrap">
      <div class="progress-bar-track">
        <div class="progress-bar-fill" id="progressFill"></div>
      </div>
      <div class="progress-label" id="progressLabel"></div>
    </div>

    <!-- Results -->
    <div class="results-box" id="resultsBox">
      <div class="empty-state">
        <div class="empty-icon">◈</div>
        <div class="empty-title">No scan running</div>
        <div class="empty-hint">Configure strategy and universe above, then click Run Scanner</div>
      </div>
    </div>

    <!-- Footer -->
    <footer>
      <span>Data sourced from Upstox API. Not financial advice.</span>
      <span>NSEScan v2.0 · <a href="https://github.com" target="_blank">GitHub</a></span>
    </footer>

  </div><!-- /page -->

  <script>
    /* ═══════════════════════════════════════════════════════════════
       CONFIG
       • Local dev : set LOCAL_PORT to whatever port your Flask app runs on
       • Production: set PROD_URL to your deployed backend URL
    ═══════════════════════════════════════════════════════════════ */
    const LOCAL_PORT = 5001;                          // ← change if your port differs
    const PROD_URL = 'https://YOUR-BACKEND.onrender.com'; // ← set after cloud deploy

    const IS_LOCAL = ['localhost', '127.0.0.1'].includes(location.hostname);
    const BACKEND = IS_LOCAL
      ? `http://localhost:${LOCAL_PORT}`
      : PROD_URL;

    /* ───────────────────────────────────────────────────────────── */
    let strategies = [];

    function $(id) { return document.getElementById(id); }

    async function init() {
      // Set date
      $('headerDate').textContent = new Date().toLocaleDateString('en-IN', {
        weekday: 'short', day: 'numeric', month: 'short', year: 'numeric'
      });

      await Promise.all([loadStrategies(), loadUniverses()]);

      $('strategySelect').addEventListener('change', onStrategyChange);
      $('universeSelect').addEventListener('change', checkReady);
    }

    /* ── Loaders ── */
    async function loadStrategies() {
      try {
        const r = await fetch(`${BACKEND}/api/strategies`);
        strategies = await r.json();
        const sel = $('strategySelect');
        strategies.forEach(s => {
          const o = document.createElement('option');
          o.value = s.name;
          o.textContent = s.name;
          sel.appendChild(o);
        });
      } catch {
        showError(`Cannot reach backend at ${BACKEND}. Check that Flask is running and LOCAL_PORT matches (currently ${LOCAL_PORT}).`);
      }
    }

    async function loadUniverses() {
      try {
        const r = await fetch(`${BACKEND}/api/universes`);
        const us = await r.json();
        const sel = $('universeSelect');
        us.forEach(u => {
          const o = document.createElement('option');
          o.value = u.name;
          o.textContent = `${u.name}  (${u.count} stocks)`;
          sel.appendChild(o);
        });
      } catch { /* error already shown */ }
    }

    /* ── Events ── */
    function onStrategyChange() {
      const name = $('strategySelect').value;
      const info = $('strategyInfo');
      const s = strategies.find(x => x.name === name);
      if (s) {
        info.textContent = s.description;
        info.classList.add('show');
      } else {
        info.classList.remove('show');
      }
      checkReady();
    }

    function checkReady() {
      $('scanBtn').disabled = !($('strategySelect').value && $('universeSelect').value);
    }

    /* ── Scanner ── */
    async function runScan() {
      const strategy = $('strategySelect').value;
      const universe = $('universeSelect').value;

      hideError();
      setLoading(true);
      clearProgress();
      $('statusMsg').innerHTML = `<span style="color:var(--text-2)">Scanning ${universe}…</span>`;
      $('scanTime').textContent = '';
      $('resultsBox').innerHTML = emptyState('Scanning…', `Running ${strategy} across ${universe} stocks`);

      const t0 = Date.now();
      const matches = [];
      let total = 0;
      let scanDone = false;

      const url = `${BACKEND}/api/scan/stream?strategy=${encodeURIComponent(strategy)}&universe=${encodeURIComponent(universe)}`;
      const es = new EventSource(url);

      // Show progress bar immediately so it's visible even for fast scans
      $('progressWrap').classList.add('show');
      $('progressFill').style.width = '0%';
      $('progressLabel').textContent = 'Starting scan…';

      es.onmessage = (e) => {
        const event = JSON.parse(e.data);

        // total comes from progress/match events
        if (event.total) total = event.total;
        if (event.total_scanned) total = event.total_scanned;

        if (!scanDone && (event.type === 'progress' || event.type === 'match')) {
          if (event.type === 'match') matches.push(event);
          const pct = total > 0 ? Math.round((event.completed / total) * 100) : 0;
          updateProgress(pct, event.completed, total, matches.length);
          if (event.type === 'match') {
            renderLive(matches, strategy, universe, total, event.completed);
          }
        }

        if (event.type === 'done') {
          es.close();
          scanDone = true;
          const ms = Date.now() - t0;
          matches.sort((a, b) => {
            const sa = a.strength === 'Strong' ? 0 : 1;
            const sb = b.strength === 'Strong' ? 0 : 1;
            if (sa !== sb) return sa - sb;
            return Math.abs(b.change_pct) - Math.abs(a.change_pct);
          });
          // Fill to 100% briefly before hiding
          $('progressFill').style.width = '100%';
          $('progressLabel').textContent = `${total} / ${total} stocks scanned  ·  100%`;
          setTimeout(() => {
            clearProgress();
            render({ strategy, universe, total_scanned: total, matches: matches.length, results: matches });
            $('scanTime').textContent = `Completed in ${(ms / 1000).toFixed(1)}s`;
            setLoading(false);
          }, 400);
        }

        if (event.type === 'error') {
          es.close();
          showError(`Scan error: ${event.message}`);
          $('statusMsg').textContent = 'Scan failed.';
          clearProgress();
          setLoading(false);
        }
      };

      es.onerror = () => {
        es.close();
        showError('Connection to backend lost. Check that Flask is running.');
        $('statusMsg').textContent = 'Scan failed.';
        clearProgress();
        setLoading(false);
      };
    }

    function updateProgress(pct, completed, total, matchCount) {
      $('progressWrap').classList.add('show');
      $('progressFill').style.width = `${pct}%`;
      $('progressLabel').textContent = `${completed} / ${total} stocks scanned  ·  ${pct}%`;
      $('statusMsg').innerHTML =
        `<span style="color:var(--text-2)">Scanning… found <strong style="color:var(--accent)">${matchCount} match${matchCount !== 1 ? 'es' : ''}</strong> so far</span>`;
    }

    function clearProgress() {
      $('progressWrap').classList.remove('show');
      $('progressFill').style.width = '0%';
      $('progressLabel').textContent = '';
    }

    function renderLive(matches, strategy, universe, total, completed) {
      const strong = matches.filter(r => r.strength === 'Strong').length;
      const moderate = matches.length - strong;

      const summaryHTML = `
    <div class="summary-bar">
      <div class="summary-left">
        <span class="chip chip-amber">${strategy}</span>
        <span class="chip chip-dim">${universe}</span>
        ${strong ? `<span class="chip chip-green">⬆ ${strong} Strong</span>` : ''}
        ${moderate ? `<span class="chip chip-blue">◉ ${moderate} Moderate</span>` : ''}
      </div>
      <span class="summary-right">${completed} / ${total} scanned</span>
    </div>`;

      const rows = matches.map((r, i) => rowHTML(r, i)).join('');

      $('resultsBox').innerHTML = `
    ${summaryHTML}
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Ticker</th><th>Price (₹)</th><th>Change</th>
            <th>Signal</th><th>Strength</th>
            <th class="r-hide" style="text-align:right">Metric</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
    }

    function rowHTML(r, i) {
      const up = r.change_pct >= 0;
      const chgCl = up ? 'up' : 'down';
      const arrow = up ? '▲' : '▼';
      const str = (r.strength || 'Moderate').toLowerCase().replace(' ', '');
      return `
    <tr style="animation-delay:${Math.min(i * 30, 300)}ms">
      <td><div class="t-ticker"><span class="t-name">${r.ticker}</span><span class="t-exch">NSE · India</span></div></td>
      <td><div class="t-price">₹${fmt(r.price)}</div></td>
      <td><div class="t-change ${chgCl}">${arrow} ${Math.abs(r.change_pct)}%</div></td>
      <td><div class="t-signal"><span class="sig-dot ${str}"></span><span class="sig-text">${r.signal}</span></div></td>
      <td><span class="strength-pill ${str}">${r.strength}</span></td>
      <td class="r-hide"><div class="t-metric-label">${r.metric_label || ''}</div><div class="t-metric">${r.metric_value || '—'}</div></td>
    </tr>`;
    }

    /* ── Renderer ── */
    function render(data) {
      const { strategy, universe, total_scanned, matches, results } = data;

      $('statusMsg').innerHTML =
        matches
          ? `Scanned <strong>${total_scanned}</strong> stocks &nbsp;·&nbsp; <span style="color:var(--accent)"><strong>${matches}</strong> match${matches !== 1 ? 'es' : ''}</span>`
          : `Scanned <strong>${total_scanned}</strong> stocks &nbsp;·&nbsp; <span style="color:var(--red)">0 matches</span>`;

      if (!matches) {
        $('resultsBox').innerHTML = emptyState(
          'No matches found',
          `No stocks in ${universe} match the ${strategy} criteria right now`
        );
        return;
      }

      const strongCount = results.filter(r => r.strength === 'Strong').length;
      const moderateCount = matches - strongCount;

      const summaryHTML = `
    <div class="summary-bar">
      <div class="summary-left">
        <span class="chip chip-amber">${strategy}</span>
        <span class="chip chip-dim">${universe}</span>
        ${strongCount ? `<span class="chip chip-green">⬆ ${strongCount} Strong</span>` : ''}
        ${moderateCount ? `<span class="chip chip-blue">◉ ${moderateCount} Moderate</span>` : ''}
      </div>
      <span class="summary-right">${total_scanned} stocks scanned</span>
    </div>`;

      const rows = results.map((r, i) => rowHTML(r, i)).join('');

      $('resultsBox').innerHTML = `
    ${summaryHTML}
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Ticker</th>
            <th>Price (₹)</th>
            <th>Change</th>
            <th>Signal</th>
            <th>Strength</th>
            <th class="r-hide" style="text-align:right">Metric</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
    }

    function emptyState(title, hint) {
      return `
    <div class="empty-state">
      <div class="empty-icon">○</div>
      <div class="empty-title">${title}</div>
      <div class="empty-hint">${hint}</div>
    </div>`;
    }

    /* ── Helpers ── */
    function fmt(n) {
      return Number(n).toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function setLoading(on) {
      $('spinner').classList.toggle('on', on);
      $('scanBtn').disabled = on;
    }

    function showError(msg) {
      const b = $('errorBox');
      b.textContent = '⚠  ' + msg;
      b.classList.add('show');
    }

    function hideError() {
      $('errorBox').classList.remove('show');
    }

    init();
  </script>
</body>

</html>